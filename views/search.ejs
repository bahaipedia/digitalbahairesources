<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Research Assistant - Digital Bahá’í Resources</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/search.css">
    <link rel="icon" href="images/dbs-favicon.png" type="image/png">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <%- include('partials/header', { mini: false }) %>
    
    <main>
        <section class="content-area">
            <div class="search-container">
                <section class="search-header">
                    <h2>
                        <span class="intro-text">Ask questions and receive answers sourced from</span>
                        <span class="source-text">Bahaipedia.org and Bahai.works</span>
                    </h2>
                </section>

                <form class="search-box-area" onsubmit="startSearch(); return false;">
                    <input type="text" id="userQuery" placeholder="Example: What is the Baha'i concept of heaven?">
                    <button id="searchBtn" type="submit">Search</button>
                </form>

                <div id="statusArea" class="hidden">
                    <div class="status-message" id="statusText">Initializing...</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill"></div>
                    </div>
                    <p class="status-subtext">This system runs on-demand to save resources. Waking up the engine usually takes about 90 seconds.</p>
                </div>
                <div id="resultsArea" class="hidden">
                    <div class="article-content" id="articleText"></div>

                    <details id="sourcesContainer" class="sources-container hidden">
                        <summary>View Sources Consulted</summary>
                        <ul class="sources-list" id="sourcesText"></ul>
                    </details>
                </div>
            </div>
        </section>
    </main>

    <%- include('partials/footer') %>

    <script>
        async function startSearch() {
            const query = document.getElementById('userQuery').value;
            if (!query) return;

            // UI Updates
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            
            // Clear previous results
            document.getElementById('articleText').innerHTML = "";
            document.getElementById('sourcesText').innerHTML = "";
            document.getElementById('sourcesContainer').classList.add('hidden');
            
            pollServer(query);
        }

        async function pollServer(query) {
            try {
                const response = await fetch('/api/search/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: query })
                });

                const data = await response.json();

                if (data.status === 'booting') {
                    document.getElementById('statusText').innerText = data.message;
                    setTimeout(() => pollServer(query), 5000);
                } else if (data.status === 'ready') {
                    document.getElementById('statusArea').classList.add('hidden');
                    document.getElementById('resultsArea').classList.remove('hidden');

                    // Parse Markdown to HTML for the main article
                    document.getElementById('articleText').innerHTML = marked.parse(data.data.markdown);
                    
                    // Render Sources
                    if (data.data.sources && data.data.sources.length > 0) {
                        const list = document.getElementById('sourcesText');
                        list.innerHTML = ''; // Clear previous sources just in case
                        data.data.sources.forEach(src => {
                            const li = document.createElement('li');
                            li.textContent = src;
                            list.appendChild(li);
                        });
                        document.getElementById('sourcesContainer').classList.remove('hidden');
                    }

                    document.getElementById('searchBtn').disabled = false;
                }
            } catch (err) {
                console.error(err);
                document.getElementById('statusText').innerText = "Error connecting to research node.";
                document.getElementById('searchBtn').disabled = false;
            }
        }
    </script>
</body>
</html>

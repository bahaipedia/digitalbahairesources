<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Research Assistant - Digital Bahá’í Resources</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/search.css">
    <link rel="icon" href="images/dbs-favicon.png" type="image/png">
</head>
<body>
    <%- include('partials/header', { mini: false }) %>
    
    <main class="search-container">
        <section class="search-header">
            <h1>Archive Research Assistant</h1>
            <p>Ask questions across Bahaipedia, Bahai.works, and Bahai.media.</p>
        </section>

        <section class="search-box-area">
            <textarea id="userQuery" placeholder="Example: What is the history of the House of Worship in Chicago?"></textarea>
            <button id="searchBtn" onclick="startSearch()">Research</button>
        </section>

        <div id="statusArea" class="hidden">
            <div class="status-message" id="statusText">Initializing...</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill"></div>
            </div>
            <p class="status-subtext">This system runs on-demand to save resources. Waking up the engine usually takes about 90 seconds.</p>
        </div>

        <div id="resultsArea" class="hidden">
            <div class="article-content" id="articleText"></div>
            <div class="sources-list" id="sourcesText"></div>
        </div>
    </main>

    <%- include('partials/footer') %>

    <script>
        async function startSearch() {
            const query = document.getElementById('userQuery').value;
            if (!query) return;

            // UI Updates
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('statusArea').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            
            pollServer(query);
        }

        async function pollServer(query) {
            try {
                const response = await fetch('/api/research/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: query })
                });

                const data = await response.json();

                if (data.status === 'booting') {
                    // Update status text
                    document.getElementById('statusText').innerText = data.message;
                    // Poll again in 5 seconds
                    setTimeout(() => pollServer(query), 5000);
                } else if (data.status === 'ready') {
                    // Show Results
                    document.getElementById('statusArea').classList.add('hidden');
                    document.getElementById('resultsArea').classList.remove('hidden');
                    document.getElementById('articleText').innerHTML = data.data.markdown; // Assume markdown response
                    document.getElementById('searchBtn').disabled = false;
                }
            } catch (err) {
                document.getElementById('statusText').innerText = "Error connecting to research node.";
                document.getElementById('searchBtn').disabled = false;
            }
        }
    </script>
</body>
</html>

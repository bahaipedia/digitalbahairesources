<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Archive Downloader</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/media-dumps.css">
    <link rel="icon" href="/images/dbs-favicon.png" type="image/png">
</head>
<body>
    <%- include('partials/header', { mini: false }) %>
    <main>
        <section class="content-area">
            <h1 class="centered">Bahai.media File Downloader</h1>
            
            <p>Use this tool to generate a download manifest for specific image categories. This allows you to download full-resolution images while preserving the category structure (bahai.media categories become folders and sub-folders on your computer).</p>

            <div class="step-box">
    <h2>Step 1: Select Categories</h2>
    <p>Search for categories and check the boxes for the ones you want. Subcategories are automatically included in the download.</p>
    
    <div class="explorer-container">
        <div class="explorer-search">
            <input type="text" id="catSearch" placeholder="Type to search categories (e.g. 'House', 'Bahá')..." autocomplete="off">
        </div>
        <ul id="treeRoot" class="explorer-tree">
            <li style="color: #666; padding: 10px; text-align: center;">Start typing above to find categories.</li>
        </ul>
    </div>

    <div style="margin-top: 15px; display: flex; align-items: center; gap: 15px;">
        <button id="generateBtn" class="btn-generate">Generate Manifest</button>
        <span id="selection-summary" style="color: #666;">0 categories selected</span>
    </div>

    <div id="manifest-result">
        <p><strong>Success!</strong> Found <span id="file-count">0</span> images.</p>
        <a id="download-link" href="#" class="btn-download-json" download="media_manifest.json">Download manifest.json</a>
    </div>
    <p id="error-msg" style="color: red; display: none; margin-top: 10px;"></p>
</div>

<%- include('partials/footer') %>

<script>
    // --- Copy Button Logic (Unchanged) ---
    document.getElementById('copyBtn').addEventListener('click', () => {
        const code = document.getElementById('pythonCode').innerText;
        navigator.clipboard.writeText(code);
        // (Optional: visual feedback code here)
    });

    // --- EXPLORER WIDGET LOGIC ---
    
    const treeRoot = document.getElementById('treeRoot');
    const searchInput = document.getElementById('catSearch');
    const generateBtn = document.getElementById('generateBtn');
    const summarySpan = document.getElementById('selection-summary');
    
    // 1. Search Debounce
    let debounceTimer;
    searchInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => performSearch(e.target.value), 300);
    });

    async function performSearch(query) {
        if (query.length < 2) return;
        
        treeRoot.innerHTML = '<li style="padding:10px; color:#666;">Searching...</li>';
        
        try {
            const res = await fetch(`/api/media/search-categories?q=${encodeURIComponent(query)}`);
            const categories = await res.json();
            
            treeRoot.innerHTML = '';
            if (categories.length === 0) {
                treeRoot.innerHTML = '<li style="padding:10px; color:#666;">No matches found.</li>';
                return;
            }

            // Render Search Results as Root Nodes
            categories.forEach(catName => {
                const node = createTreeNode(catName);
                treeRoot.appendChild(node);
            });
        } catch (err) {
            console.error(err);
            treeRoot.innerHTML = '<li style="color:red">Error searching.</li>';
        }
    }

    // 2. Create Tree Node Helper
    function createTreeNode(catName) {
        const li = document.createElement('li');
        li.className = 'tree-item';
        
        // HTML Structure: 
        // <div> [Toggle] [Checkbox] [Label] </div>
        // <ul> (Children) </ul>
        
        const row = document.createElement('div');
        row.className = 'tree-row';
        
        const toggle = document.createElement('span');
        toggle.className = 'tree-toggle';
        toggle.textContent = '▶'; 
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'tree-checkbox';
        checkbox.value = catName;
        checkbox.addEventListener('change', updateSummary);
        
        const label = document.createElement('span');
        label.className = 'tree-label';
        label.textContent = catName;
        // Clicking label checks the box
        label.addEventListener('click', () => {
            checkbox.checked = !checkbox.checked;
            updateSummary();
        });

        row.appendChild(toggle);
        row.appendChild(checkbox);
        row.appendChild(label);
        li.appendChild(row);

        // Container for children
        const childContainer = document.createElement('ul');
        childContainer.className = 'tree-children';
        li.appendChild(childContainer);

        // Toggle Logic (Lazy Load)
        let loaded = false;
        toggle.addEventListener('click', async () => {
            if (childContainer.classList.contains('visible')) {
                // Collapse
                childContainer.classList.remove('visible');
                toggle.classList.remove('expanded');
            } else {
                // Expand
                toggle.classList.add('expanded');
                childContainer.classList.add('visible');
                
                if (!loaded) {
                    childContainer.innerHTML = '<li style="padding:5px 0 0 25px; color:#999;">Loading...</li>';
                    try {
                        const res = await fetch(`/api/media/subcategories?parent=${encodeURIComponent(catName)}`);
                        const children = await res.json();
                        
                        childContainer.innerHTML = ''; // Clear loading
                        
                        if (children.length === 0) {
                            childContainer.innerHTML = '<li style="padding:5px 0 0 25px; color:#ccc; font-style:italic;">No subcategories</li>';
                        } else {
                            children.forEach(childName => {
                                childContainer.appendChild(createTreeNode(childName));
                            });
                        }
                        loaded = true;
                    } catch (err) {
                        childContainer.innerHTML = '<li style="color:red">Error loading.</li>';
                    }
                }
            }
        });

        return li;
    }

    function updateSummary() {
        const checked = document.querySelectorAll('.tree-checkbox:checked');
        summarySpan.textContent = `${checked.length} categories selected`;
    }

    // 3. Generate Manifest Submit Logic
    generateBtn.addEventListener('click', async () => {
        const errorMsg = document.getElementById('error-msg');
        const resultBox = document.getElementById('manifest-result');
        const checkboxes = document.querySelectorAll('.tree-checkbox:checked');

        errorMsg.style.display = 'none';
        resultBox.style.display = 'none';

        if (checkboxes.length === 0) {
            errorMsg.textContent = "Please select at least one category.";
            errorMsg.style.display = 'block';
            return;
        }

        const selectedCategories = Array.from(checkboxes).map(cb => cb.value);
        generateBtn.disabled = true;
        generateBtn.textContent = "Generating...";

        try {
            const response = await fetch('/api/media/generate-manifest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ categories: selectedCategories })
            });

            const data = await response.json();

            if (response.ok) {
                if (data.count === 0) {
                    errorMsg.textContent = "No images found in the selected categories.";
                    errorMsg.style.display = 'block';
                } else {
                    document.getElementById('file-count').textContent = data.count;
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.getElementById('download-link');
                    link.href = url;
                    link.download = `media_manifest.json`;
                    
                    resultBox.style.display = 'block';
                }
            } else {
                errorMsg.textContent = data.error || "Server error.";
                errorMsg.style.display = 'block';
            }
        } catch (err) {
            console.error(err);
            errorMsg.textContent = "Network error.";
            errorMsg.style.display = 'block';
        } finally {
            generateBtn.disabled = false;
            generateBtn.textContent = "Generate Manifest";
        }
    });
</script>
</body>
</html>
